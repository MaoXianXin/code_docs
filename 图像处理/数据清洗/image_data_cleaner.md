# 图像数据清洗工具

## 版本 0.1

### 概述

本工具旨在自动化清洗图像数据集。它执行以下操作：

1. 验证文件后缀名是否为常见图像格式。
2. 读取文件头部以确认文件格式。
3. 处理Exif数据以确保图像方向正确。
4. 将非RGB图像转换为RGB格式。
5. 验证图像文件的完整性。
6. 检查图像大小，移除过大的文件。

### 环境要求

- Python 3.x
- Pillow库
- shutil库
- csv库
- concurrent.futures库

### 安装指南

1. 确保Python 3.x已安装。
2. 安装Pillow库：`pip install Pillow`
3. 其他依赖库通常随Python一起安装。

### 使用说明

1. 设置`source_dir`变量为包含原始图像数据集的目录路径。
2. 设置`destination_dir`变量为清洗后图像保存的目录路径。
3. 运行脚本将自动执行清洗过程。

### 功能详解

#### 日志记录

- `log_message`: 记录消息到日志文件。如果消息是异常，会相应格式化。

#### 图像处理

- `process_and_save_as_jpeg`: 处理单个图像文件，将其转换为JPEG格式，并保存。

#### 文件处理

- `process_file`: 处理单个文件，包括复制、重命名、格式转换、完整性检查和大小检查。

#### 线程同步

- 使用`threading.Lock`确保日志和元数据文件的线程安全。

### 代码结构

- 全局变量定义。
- `log_message`函数定义。
- 检查和创建目标目录。
- 元数据文件初始化。
- `is_image_corrupted`函数定义。
- `process_and_save_as_jpeg`函数定义。
- 线程锁定义。
- `process_file`函数定义。
- 线程池创建和文件处理任务分配。
- 日志记录结束。

### 异常处理

- 在文件处理过程中，任何异常都会记录在日志文件中，并且会删除有问题的文件。

### 性能

- 使用`ThreadPoolExecutor`来并行处理文件，最大工作线程数为15。

### 日志和元数据

- 生成的`metadata.csv`包含处理后的新路径、原始路径和文件大小。
- `cleaning_log.txt`记录了处理过程中的所有重要事件。

### 限制条件

- 文件大小限制为5MB。超过此大小的文件将被删除。
- 仅支持JPG, JPEG, PNG, BMP, TIFF格式的图像文件。

### 更新记录

- 修复已知bug。
- 优化性能。

### 联系方式

- 作者: mao
- 版本: 0.1
- 语言: 中文

---

请注意，这是一个技术文档的初稿，可能需要根据实际使用和反馈进行进一步的细化和改进。如果有任何具体的修改要求或者额外的信息需要包含在文档中，请告知。